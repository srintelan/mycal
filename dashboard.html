// Ganti bagian <script type="module"> di dashboard.html dengan ini:

import { 
    requireAuth, 
    getCurrentUser, 
    logoutUser, 
    getOnlineUsers, 
    updateUserActivity,
    subscribeToOnlineUsers,
    subscribeToActivityLogs,
    getActivityLogs,
    trackNavigation,
    testActivityLogsAccess,
    getSupabase  // GANTI dari 'supabase' ke 'getSupabase'
} from './supabase-client.js';

requireAuth();

const menuBtn = document.getElementById('menuBtn');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const logoutBtn = document.getElementById('logoutBtn');
const userGreeting = document.getElementById('userGreeting');
const userEmail = document.getElementById('userEmail');
const welcomeMessage = document.getElementById('welcomeMessage');
const onlineCount = document.getElementById('onlineCount');
const usersList = document.getElementById('usersList');
const activityList = document.getElementById('activityList');
const refreshUsers = document.getElementById('refreshUsers');
const refreshActivities = document.getElementById('refreshActivities');

function toggleSidebar() {
    menuBtn.classList.toggle('open');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

menuBtn.addEventListener('click', toggleSidebar);
overlay.addEventListener('click', toggleSidebar);

logoutBtn.addEventListener('click', async () => {
    await logoutUser();
});

async function loadUserInfo() {
    const user = await getCurrentUser();
    if (user) {
        userGreeting.textContent = `Halo, ${user.username}`;
        userEmail.textContent = user.nik;
        welcomeMessage.textContent = `Selamat Datang, ${user.username}!`;
    }
}

async function loadOnlineUsers() {
    const users = await getOnlineUsers();
    onlineCount.textContent = users.length;
    document.getElementById('onlineUsersCount').textContent = users.length;

    if (users.length === 0) {
        usersList.innerHTML = '<div class="no-data">Tidak ada user online saat ini</div>';
        return;
    }

    usersList.innerHTML = users.map(user => {
        const initial = user.username.charAt(0).toUpperCase();
        return `
            <div class="user-card">
                <div class="user-avatar">${initial}</div>
                <div class="user-info">
                    <div class="username">${user.username}</div>
                    <div class="status">
                        <span class="status-dot"></span>
                        Online
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function formatTimeAgo(dateString) {
    const now = new Date();
    const past = new Date(dateString);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Baru saja';
    if (diffMins < 60) return `${diffMins} menit yang lalu`;
    if (diffHours < 24) return `${diffHours} jam yang lalu`;
    return `${diffDays} hari yang lalu`;
}

function getActivityIcon(activityType) {
    switch(activityType) {
        case 'LOGIN':
            return '<i class="fa fa-sign-in-alt"></i>';
        case 'LOGOUT':
            return '<i class="fa fa-sign-out-alt"></i>';
        case 'NAVIGATION':
            return '<i class="fa fa-mouse-pointer"></i>';
        case 'PAGE_UNLOAD':
            return '<i class="fa fa-door-open"></i>';
        default:
            return '<i class="fa fa-info-circle"></i>';
    }
}

function getActivityIconClass(activityType) {
    switch(activityType) {
        case 'LOGIN':
            return 'login';
        case 'LOGOUT':
        case 'PAGE_UNLOAD':
            return 'logout';
        case 'NAVIGATION':
            return 'navigation';
        default:
            return 'navigation';
    }
}

async function loadActivityLogs() {
    console.log('=== Loading Activity Logs ===');
    
    try {
        // Test access first
        const testResult = await testActivityLogsAccess();
        console.log('Access test result:', testResult);
        
        if (!testResult.success) {
            console.error('Cannot access activity_logs table');
            activityList.innerHTML = `
                <div class="no-data" style="color: #dc3545;">
                    <i class="fa fa-exclamation-triangle"></i><br>
                    Error mengakses data aktivitas.<br>
                    <small>Periksa RLS policies di Supabase.</small>
                    <br><br>
                    <button onclick="location.reload()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Coba Lagi
                    </button>
                </div>
            `;
            return;
        }
        
        // Get actual data
        const activities = await getActivityLogs(50);
        console.log('Activities fetched:', activities?.length || 0);
        
        document.getElementById('totalActivities').textContent = activities.length;

        if (activities.length === 0) {
            // PERBAIKAN: Gunakan getSupabase() dengan await
            const supabase = await getSupabase();
            const { count } = await supabase
                .from('activity_logs')
                .select('*', { count: 'exact', head: true });
            
            console.log('Total records in database:', count);
            
            if (count > 0) {
                activityList.innerHTML = `
                    <div class="no-data" style="color: #dc3545;">
                        <i class="fa fa-exclamation-triangle"></i><br>
                        Ada ${count} aktivitas di database tapi tidak bisa diakses.<br>
                        <small>Periksa RLS policies untuk tabel activity_logs.</small>
                    </div>
                `;
            } else {
                activityList.innerHTML = '<div class="no-data">Belum ada aktivitas</div>';
            }
            return;
        }

        activityList.innerHTML = activities.map(activity => {
            const username = activity.users?.username || 'Unknown User';
            return `
                <div class="activity-item">
                    <div class="activity-icon ${getActivityIconClass(activity.activity_type)}">
                        ${getActivityIcon(activity.activity_type)}
                    </div>
                    <div class="activity-content">
                        <div class="username">${username}</div>
                        <div class="description">${activity.description}</div>
                        <div class="time">${formatTimeAgo(activity.created_at)}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log('Successfully loaded and displayed activities');
        
    } catch (err) {
        console.error('Error in loadActivityLogs:', err);
        activityList.innerHTML = `
            <div class="no-data" style="color: #dc3545;">
                <i class="fa fa-exclamation-triangle"></i><br>
                Error: ${err.message || 'Terjadi kesalahan'}
                <br><br>
                <button onclick="location.reload()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Refresh Halaman
                </button>
            </div>
        `;
    }
}

async function loadStats() {
    try {
        // PERBAIKAN: Gunakan getSupabase() dengan await
        const supabase = await getSupabase();
        const { count: totalUsers } = await supabase
            .from('users')
            .select('*', { count: 'exact', head: true });
        
        document.getElementById('totalUsers').textContent = totalUsers || 0;
    } catch (err) {
        console.error('Error loading stats:', err);
    }
}

// Track menu clicks
document.querySelectorAll('a[data-menu]').forEach(link => {
    link.addEventListener('click', function() {
        const menuName = this.getAttribute('data-menu');
        trackNavigation(menuName);
    });
});

// Refresh buttons
refreshUsers.addEventListener('click', loadOnlineUsers);
refreshActivities.addEventListener('click', () => {
    console.log('Manual refresh triggered');
    loadActivityLogs();
});

// Subscribe to realtime updates
subscribeToOnlineUsers(loadOnlineUsers);
subscribeToActivityLogs((newActivity) => {
    console.log('Received new activity via realtime:', newActivity);
    loadActivityLogs();
});

// Initial load
console.log('=== Dashboard Initializing ===');
loadUserInfo();
loadOnlineUsers();
loadActivityLogs();
loadStats();

// Update user activity every minute
setInterval(updateUserActivity, 60000);

// Refresh data periodically
setInterval(loadOnlineUsers, 30000);
setInterval(loadActivityLogs, 60000);

console.log('=== Dashboard Initialized ===');